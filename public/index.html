<!DOCTYPE html>
<html>
<head>
  <title>AltoCRM</title>
  <style>
    table { border-collapse: collapse; width: 100%; }
    th, td { border: 1px solid #ccc; padding: 6px; }
    th { background: #f0f0f0; }
    button { margin: 3px; }
  </style>
</head>
<body>

<h2>AltoCRM</h2>

<form id="leadForm">
  <input id="full_name" placeholder="Full Name">
  <input id="email" placeholder="Email">
  <input id="company" placeholder="Company">
  <button>Add</button>
</form>

<hr>

<label>Company Filter:</label>
<select id="companyFilter">
  <option value="">All</option>
  <option value="__BLANK__">(Blank)</option>
</select>

<button id="bulkDelete">Delete Selected</button>
<button id="undoBtn" style="display:none;">Undo Delete</button>

<table>
  <thead>
    <tr>
      <th><input type="checkbox" id="selectAll"></th>
      <th>Name</th><th>Email</th><th>Company</th><th>Action</th>
    </tr>
  </thead>
  <tbody id="tbody"></tbody>
</table>

<script>
let allLeads = [];
let deletedIds = [];
let undoTimer = null;

/* ---------- LOAD ---------- */
async function load() {
  const res = await fetch("/api/leads");
  allLeads = await res.json();
  populateFilter();
  render(allLeads);
}

function populateFilter() {
  const sel = document.getElementById("companyFilter");
  const values = [...new Set(allLeads.map(l => l.company).filter(v => v))];
  sel.innerHTML = `<option value="">All</option><option value="__BLANK__">(Blank)</option>`;
  values.forEach(v => sel.innerHTML += `<option>${v}</option>`);
}

/* ---------- RENDER ---------- */
function render(data) {
  const tbody = document.getElementById("tbody");
  tbody.innerHTML = "";
  data.forEach(l => {
    tbody.innerHTML += `
      <tr>
        <td><input type="checkbox" class="rowCheck" value="${l.id}"></td>
        <td>${l.full_name || ""}</td>
        <td>${l.email || ""}</td>
        <td>${l.company || ""}</td>
        <td><button onclick="deleteRows([${l.id}])">Delete</button></td>
      </tr>`;
  });
}

/* ---------- FILTER ---------- */
document.getElementById("companyFilter").onchange = e => {
  const v = e.target.value;
  let filtered = [...allLeads];

  if (v === "__BLANK__") {
    filtered = filtered.filter(l => !l.company || l.company.trim() === "");
  } else if (v) {
    filtered = filtered.filter(l => l.company === v);
  }

  render(filtered);
};

/* ---------- ADD ---------- */
document.getElementById("leadForm").onsubmit = async e => {
  e.preventDefault();
  await fetch("/api/leads", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      full_name: full_name.value,
      email: email.value,
      company: company.value
    })
  });
  leadForm.reset();
  load();
};

/* ---------- DELETE + UNDO ---------- */
async function deleteRows(ids) {
  deletedIds = ids;

  await fetch("/api/leads/delete", {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({ ids })
  });

  document.getElementById("undoBtn").style.display = "inline";
  clearTimeout(undoTimer);
  undoTimer = setTimeout(() => {
    deletedIds = [];
    document.getElementById("undoBtn").style.display = "none";
    load();
  }, 5000);
}

/* ---------- RESTORE ---------- */
document.getElementById("undoBtn").onclick = async () => {
  await fetch("/api/leads/restore", {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({ ids: deletedIds })
  });
  deletedIds = [];
  document.getElementById("undoBtn").style.display = "none";
  load();
};

/* ---------- BULK ---------- */
document.getElementById("bulkDelete").onclick = () => {
  const ids = [...document.querySelectorAll(".rowCheck:checked")].map(c => +c.value);
  if (ids.length) deleteRows(ids);
};

document.getElementById("selectAll").onclick = e => {
  document.querySelectorAll(".rowCheck").forEach(c => c.checked = e.target.checked);
};

load();
</script>

</body>
</html>
