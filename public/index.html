<!DOCTYPE html>
<html>
<head>
  <title>AltoCRM</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    table { border-collapse: collapse; width: 100%; }
    th, td { border: 1px solid #ccc; padding: 6px; font-size: 13px; }
    th { background: #f4f4f4; position: sticky; top: 0; z-index: 2; }
    tr.filter-row th { background: #fff; top: 28px; z-index: 1; }
    input, select { width: 95%; font-size: 12px; }
    td:hover { background: #fafafa; cursor: pointer; }
  </style>
</head>
<body>

<h2>AltoCRM – Filterable CRM Grid</h2>

<button onclick="addLead()">➕ Add Lead</button>
<br><br>

<table id="grid"></table>

<script>
let fields = [];
let leads = [];
let filters = {};

async function load() {
  fields = await fetch("/api/fields").then(r => r.json());
  leads = await fetch("/api/leads").then(r => r.json());
  render();
}

async function addLead() {
  await fetch("/api/leads", { method: "POST" });
  load();
}

function render() {
  let filtered = leads.filter(l =>
    Object.keys(filters).every(key => {
      if (!filters[key]) return true;
      const value = (l[key] || "").toLowerCase();
      return value.includes(filters[key].toLowerCase());
    })
  );

  let html = "<tr>" +
    fields.map(f => `<th>${f.label}</th>`).join("") +
    "</tr>";

  html += "<tr class='filter-row'>" +
    fields.map(f => `<th>${filterControl(f)}</th>`).join("") +
    "</tr>";

  filtered.forEach(l => {
    html += `<tr data-id="${l.id}">`;
    fields.forEach(f => {
      html += `
        <td data-field="${f.key}" ondblclick="editCell(this)">
          ${l[f.key] || ""}
        </td>`;
    });
    html += "</tr>";
  });

  document.getElementById("grid").innerHTML = html;
}

function filterControl(field) {
  if (field.type === "select" && field.options) {
    const opts =
      field.options.stages ||
      field.options.sources ||
      field.options.outcomes ||
      [];

    return `
      <select onchange="setFilter('${field.key}', this.value)">
        <option value="">All</option>
        ${opts.map(o => `<option value="${o}">${o}</option>`).join("")}
      </select>
    `;
  }

  return `<input placeholder="Filter" oninput="setFilter('${field.key}', this.value)">`;
}

function setFilter(key, value) {
  filters[key] = value;
  render();
}

function editCell(td) {
  const tr = td.parentElement;
  const leadId = tr.dataset.id;
  const fieldKey = td.dataset.field;
  const field = fields.find(f => f.key === fieldKey);
  const oldValue = td.innerText;

  td.innerHTML = "";

  if (field.type === "select" && field.options) {
    const select = document.createElement("select");
    const list =
      field.options.stages ||
      field.options.sources ||
      field.options.outcomes ||
      [];

    select.innerHTML =
      `<option value=""></option>` +
      list.map(o => `<option ${o === oldValue ? "selected" : ""}>${o}</option>`).join("");

    select.onchange = () => save(td, leadId, fieldKey, select.value);
    select.onblur = () => save(td, leadId, fieldKey, select.value);
    td.appendChild(select);
    select.focus();
    return;
  }

  const input = document.createElement("input");
  input.value = oldValue;
  input.onblur = () => save(td, leadId, fieldKey, input.value);
  input.onkeydown = e => e.key === "Enter" && input.blur();
  td.appendChild(input);
  input.focus();
}

async function save(td, leadId, fieldKey, value) {
  await fetch("/api/cell", {
    method: "PUT",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ leadId, fieldKey, value })
  });
  td.innerText = value || "";
}

load();
</script>

</body>
</html>
