<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>AltoCRM</title>
  <style>
    body { font-family: Arial; padding: 12px; }
    table { border-collapse: collapse; width: 100%; }
    th, td { border: 1px solid #ccc; padding: 6px; }
    th { background: #f3f3f3; position: sticky; top: 0; }
    select, input, textarea { width: 100%; }
    textarea { resize: vertical; }
    .toolbar { margin-bottom: 12px; }
  </style>
</head>
<body>

<h2>AltoCRM</h2>

<div class="toolbar">
  <button onclick="addLead()">âž• Add Lead</button>
  <button onclick="deleteSelected()">ðŸ—‘ Delete Selected</button>
</div>

<div id="filters"></div>

<table>
  <thead>
    <tr id="header-row"></tr>
  </thead>
  <tbody id="rows"></tbody>
</table>

<script>
let fields = [];
let leads = [];
let values = [];
let activeFilters = {};

async function loadData() {
  fields = await fetch('/api/fields').then(r => r.json());
  const data = await fetch('/api/leads').then(r => r.json());
  leads = data.leads;
  values = data.values;
  buildFilters();
  renderTable();
}

function getValue(leadId, key) {
  const v = values.find(x => x.lead_id === leadId && x.field_key === key);
  return v ? v.value : '';
}

function buildFilters() {
  const container = document.getElementById('filters');
  container.innerHTML = '';

  fields.forEach(f => {
    const wrap = document.createElement('div');
    wrap.innerHTML = `<strong>${f.label}</strong><br/>`;
    const select = document.createElement('select');

    select.innerHTML = `<option value="">-- All --</option>
                        <option value="__BLANK__">(Blank)</option>`;

    const uniqueVals = [...new Set(values
      .filter(v => v.field_key === f.key && v.value)
      .map(v => v.value))];

    uniqueVals.forEach(v => {
      const o = document.createElement('option');
      o.value = v;
      o.textContent = v;
      select.appendChild(o);
    });

    select.onchange = () => {
      if (select.value === '') delete activeFilters[f.key];
      else activeFilters[f.key] = select.value;
      renderTable();
    };

    wrap.appendChild(select);
    container.appendChild(wrap);
  });
}

function renderTable() {
  const header = document.getElementById('header-row');
  const body = document.getElementById('rows');
  header.innerHTML = '';
  body.innerHTML = '';

  header.innerHTML += `<th><input type="checkbox" onclick="toggleAll(this)"></th>`;
  fields.forEach(f => header.innerHTML += `<th>${f.label}</th>`);
  header.innerHTML += `<th>Action</th>`;

  leads.forEach(l => {
    if (!passesFilters(l.id)) return;

    const tr = document.createElement('tr');
    tr.innerHTML += `<td><input type="checkbox" class="rowcheck" data-id="${l.id}"></td>`;

    fields.forEach(f => {
      const val = getValue(l.id, f.key);
      let cell = '';

      if (f.type === 'select' && f.options) {
        const opts = Object.values(f.options)[0] || [];
        cell = `<select data-id="${l.id}" data-key="${f.key}">
          <option value=""></option>
          ${opts.map(o => `<option ${o===val?'selected':''}>${o}</option>`).join('')}
        </select>`;
      } else if (f.type === 'long_text') {
        cell = `<textarea data-id="${l.id}" data-key="${f.key}">${val||''}</textarea>`;
      } else {
        cell = `<input value="${val||''}" data-id="${l.id}" data-key="${f.key}">`;
      }

      tr.innerHTML += `<td>${cell}</td>`;
    });

    tr.innerHTML += `<td>
      <button onclick="deleteLead('${l.id}')">Delete</button>
    </td>`;

    body.appendChild(tr);
  });
}

function passesFilters(leadId) {
  return Object.entries(activeFilters).every(([key,val]) => {
    const v = getValue(leadId, key);
    if (val === '__BLANK__') return !v;
    return v === val;
  });
}

function toggleAll(cb) {
  document.querySelectorAll('.rowcheck').forEach(c => c.checked = cb.checked);
}

async function addLead() {
  await fetch('/api/leads', { method: 'POST' });
  loadData();
}

async function deleteLead(id) {
  if (!confirm('Delete this lead?')) return;
  await fetch('/api/leads/' + id, { method: 'DELETE' });
  loadData();
}

async function deleteSelected() {
  const ids = [...document.querySelectorAll('.rowcheck')]
    .filter(c => c.checked)
    .map(c => c.dataset.id);

  if (!ids.length) return;
  if (!confirm(`Delete ${ids.length} leads?`)) return;

  for (const id of ids) {
    await fetch('/api/leads/' + id, { method: 'DELETE' });
  }
  loadData();
}

loadData();
</script>
</body>
</html>
