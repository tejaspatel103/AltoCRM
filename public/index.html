<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>AltoCRM</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    table { border-collapse: collapse; width: 100%; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 6px; font-size: 13px; }
    th { background: #f4f4f4; position: sticky; top: 0; }
    input, select, textarea { width: 100%; font-size: 13px; }
    textarea { resize: vertical; }
    button { margin-right: 5px; }
  </style>
</head>

<body>
  <h2>AltoCRM</h2>

  <button onclick="addLead()">‚ûï Add Lead</button>
  <button onclick="deleteSelected()">üóëÔ∏è Delete Selected</button>

  <table>
    <thead>
      <tr id="header-row"></tr>
    </thead>
    <tbody id="table-body"></tbody>
  </table>

<script>
let fields = [];
let leads = [];

/* ‚úÖ LOAD FIELDS */
fetch('/api/fields')
  .then(r => r.json())
  .then(data => {
    fields = data.sort((a,b) => a.order_index - b.order_index);
    renderHeader();
    loadLeads();
  });

/* ‚úÖ HEADER */
function renderHeader() {
  const tr = document.getElementById('header-row');
  tr.innerHTML = `<th><input type="checkbox" onclick="toggleAll(this)"></th>`;
  fields.forEach(f => {
    tr.innerHTML += `<th>${f.label}</th>`;
  });
}

/* ‚úÖ LOAD LEADS */
function loadLeads() {
  fetch('/api/leads')
    .then(r => r.json())
    .then(data => {
      leads = data;
      renderRows();
    });
}

/* ‚úÖ RENDER ROWS */
function renderRows() {
  const tbody = document.getElementById('table-body');
  tbody.innerHTML = '';

  leads.forEach(lead => {
    const tr = document.createElement('tr');

    tr.innerHTML = `
      <td><input type="checkbox" class="row-check" data-id="${lead.id}"></td>
    `;

    fields.forEach(f => {
      const value = lead[f.key] ?? '';
      let cell = '';

      if (f.type === 'select') {
        const opts =
          (f.options?.stages || f.options?.sources || f.options?.outcomes || []);
        cell = `
          <select onchange="updateCell('${lead.id}','${f.key}',this.value)">
            <option value=""></option>
            ${opts.map(o =>
              `<option ${o === value ? 'selected' : ''}>${o}</option>`
            ).join('')}
          </select>`;
      }
      else if (f.type === 'long_text') {
        cell = `<textarea onchange="updateCell('${lead.id}','${f.key}',this.value)">${value}</textarea>`;
      }
      else {
        cell = `<input value="${value}" onchange="updateCell('${lead.id}','${f.key}',this.value)">`;
      }

      tr.innerHTML += `<td>${cell}</td>`;
    });

    tbody.appendChild(tr);
  });
}

/* ‚úÖ ADD LEAD */
function addLead() {
  fetch('/api/leads', { method: 'POST' })
    .then(() => loadLeads());
}

/* ‚úÖ UPDATE CELL */
function updateCell(leadId, fieldKey, value) {
  fetch('/api/leads/value', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      lead_id: leadId,
      field_key: fieldKey,
      value,
      source: 'manual'
    })
  });
}

/* ‚úÖ DELETE */
function deleteSelected() {
  const ids = [...document.querySelectorAll('.row-check:checked')]
    .map(cb => cb.dataset.id);

  if (!ids.length) return alert('Select at least one lead');

  fetch('/api/leads/delete', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ ids })
  }).then(() => loadLeads());
}

function toggleAll(cb) {
  document.querySelectorAll('.row-check')
    .forEach(c => c.checked = cb.checked);
}
</script>
</body>
</html>
