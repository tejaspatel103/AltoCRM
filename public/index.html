<!DOCTYPE html>
<html>
<head>
  <title>AltoCRM</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
    }

    table {
      border-collapse: collapse;
      width: 100%;
    }

    th, td {
      border: 1px solid #ccc;
      padding: 6px;
      white-space: nowrap;
      font-size: 13px;
    }

    th {
      background: #f4f4f4;
      position: sticky;
      top: 0;
      z-index: 1;
    }

    td:hover {
      background: #fafafa;
      cursor: pointer;
    }

    select, input {
      width: 95%;
      font-size: 13px;
    }
  </style>
</head>
<body>

<h2>AltoCRM – Inline Editable Grid</h2>

<button onclick="addLead()">➕ Add Lead</button>
<br><br>

<table id="grid"></table>

<script>
let fields = [];
let leads = [];

async function load() {
  fields = await fetch("/api/fields").then(r => r.json());
  leads = await fetch("/api/leads").then(r => r.json());
  render();
}

async function addLead() {
  await fetch("/api/leads", { method: "POST" });
  load();
}

function render() {
  let html = "<tr>" +
    fields.map(f => `<th>${f.label}</th>`).join("") +
    "</tr>";

  leads.forEach(l => {
    html += `<tr data-id="${l.id}">`;
    fields.forEach(f => {
      html += `
        <td data-field="${f.key}" ondblclick="editCell(this)">
          ${l[f.key] || ""}
        </td>`;
    });
    html += "</tr>";
  });

  document.getElementById("grid").innerHTML = html;
}

function editCell(td) {
  const tr = td.parentElement;
  const leadId = tr.dataset.id;
  const fieldKey = td.dataset.field;
  const field = fields.find(f => f.key === fieldKey);
  const oldValue = td.innerText;

  td.innerHTML = "";

  // SELECT FIELD → DROPDOWN
  if (field.type === "select" && field.options) {
    const select = document.createElement("select");

    // determine option list from JSONB object
    const optionList =
      field.options.stages ||
      field.options.sources ||
      field.options.outcomes ||
      [];

    select.innerHTML =
      `<option value=""></option>` +
      optionList.map(o =>
        `<option value="${o}" ${o === oldValue ? "selected" : ""}>${o}</option>`
      ).join("");

    select.onchange = () => saveCell(td, leadId, fieldKey, select.value);
    select.onblur = () => saveCell(td, leadId, fieldKey, select.value);

    td.appendChild(select);
    select.focus();
    return;
  }

  // NUMBER FIELD
  if (field.type === "number") {
    const input = document.createElement("input");
    input.type = "number";
    input.value = oldValue;

    input.onblur = () => saveCell(td, leadId, fieldKey, input.value);
    input.onkeydown = e => e.key === "Enter" && input.blur();

    td.appendChild(input);
    input.focus();
    return;
  }

  // TEXT / LONG TEXT FIELD
  const input = document.createElement("input");
  input.type = "text";
  input.value = oldValue;

  input.onblur = () => saveCell(td, leadId, fieldKey, input.value);
  input.onkeydown = e => e.key === "Enter" && input.blur();

  td.appendChild(input);
  input.focus();
}

async function saveCell(td, leadId, fieldKey, value) {
  await fetch("/api/cell", {
    method: "PUT",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ leadId, fieldKey, value })
  });

  td.innerText = value || "";
}

load();
</script>

</body>
</html>
